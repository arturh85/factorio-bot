name: "publish"
on:
  push:
    tags:
      - 'v**'

jobs:
  build-publish:
    needs: create-github-release
    name: Build & Publish
    outputs:
      release_body: ${{ needs.create-github-release.outputs.release_body }}
      package_version: ${{ needs.create-github-release.outputs.package_version }}
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.platform }}

    steps:
      # Prepare
      - name: ğŸ”¥ Checkout code
        uses: actions/checkout@v6
      - name: ğŸ› ï¸ Install nodejs 16
        uses: actions/setup-node@v6
        with:
          node-version: 16
      - name: ğŸ› ï¸ Install rust stable
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
      - name: ğŸ’¾ Cache rust dependencies
        uses: Swatinem/rust-cache@v2
      - name: ğŸ’¾ Cache javascript dependencies
        uses: actions/cache@v5
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}
      - name: ğŸ› ï¸ Install tauri-cli
        run: |
          cargo install tauri-cli
      - name: ğŸ› ï¸ Install webkit2gtk (for tauri)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y webkit2gtk-4.0 libgtksourceview-3.0-dev
      - name: ğŸ› ï¸ Install zensical
        if: matrix.platform == 'ubuntu-latest'
        uses: actions/setup-python@v5
        with:
          python-version: 3.x
      - name: ğŸ› ï¸ Install zensical package
        if: matrix.platform == 'ubuntu-latest'
        run: pip install zensical
      - name: ğŸ› ï¸ Install nodejs dependencies
        run: |
          cd app; yarn
      - name: ğŸ¦  Update version in package.json & tauri.conf.json
        id: create_version
        run: |
          cd app/scripts; node update-package-version.js

      # Javascript
      - name: ğŸ—ï¸ Build javascript code
        run: |
          cd app; yarn build:web

      # Rust
      - name: ğŸ—ï¸ Build rust code
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        run: |
          cargo build --release --timings
          cd app && yarn tauri:build

      # Output Signature
      - name: ğŸ—ï¸ Build tauri updater json
        env:
          RELEASE_BODY: ${{ needs.create-github-release.outputs.release_body }}
        run: |
          mkdir updates
          cd app/scripts; node build-auto-updater-json.js

      # Upload updater json
      - name: ğŸ“¤ï¸ Upload updater json to Job for later
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.platform }}
          path: updates/*

      # Publish tauri artifacts
      - name: ğŸ“¤ï¸ Upload artifacts to Github release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.create-github-release.outputs.id }}
          iconPath: "../public/logo.png"
          configPath: "tauri.conf.json"
          projectPath: "./app"
          tauriScript: "npm run dummy"

      # Prepare gh-pages
      - name: ğŸ—ï¸ Build rust docs
        if: matrix.platform == 'ubuntu-latest'
        run: |
          mkdir public 
          cargo doc --all --no-deps
          mv target/doc public/doc
      - name: ğŸ—ï¸ Build zensical documentation
        if: matrix.platform == 'ubuntu-latest'
        run: |
          zensical build --clean
          mv site/* public/
      - name: ğŸ—ï¸ Build lua api docs
        if: matrix.platform == 'ubuntu-latest'
        uses: ./.github/actions/ldoc/
        with:
          config-path: docs/lua/config.ld
          source-path: docs/lua/src/
      - name: ğŸ—ï¸ Fix lua api docs permissions & move to public/
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo chown -R $(id -u):$(id -g) doc/
          mv doc/ public/lua/
      - name: ğŸšš Move generated docs and stats to public/ folder
        if: matrix.platform == 'ubuntu-latest'
        run: |
          mv app/dist/stats.html public/stats.html
          mv target/cargo-timings/ public/cargo-timings/

      # Publish gh-pages
      - name: ğŸ“¤ Deploy public/ to gh-pages
        if: matrix.platform == 'ubuntu-latest'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./public
          force_orphan: true

  create-github-release:
    name: Create Github Release
    runs-on: ubuntu-latest
    outputs:
      id: ${{ steps.create_release.outputs.id }}
      release_body: ${{ steps.release.outputs.release_body }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@main
        with:
          fetch-depth: 0
      - name: ğŸ› ï¸ Install nodejs 16
        uses: actions/setup-node@v6
        with:
          node-version: 16
      - name: ğŸ¦  Update version in package.json & tauri.conf.json
        run: |
          cd app/scripts; node update-package-version.js
      - name: Generate changelog
        uses: orhun/git-cliff-action@v2
        id: git-cliff
        with:
          config: Cargo.toml
          args: -vv --latest --strip header
        env:
          OUTPUT: CHANGES.md
      - name: Set the release body to changelog
        id: release
        shell: bash
        run: |
          r=$(cat ${{ steps.git-cliff.outputs.changelog }})
          r="$(printf "$r" | tail -n +3)"
          r="${r//'%'/'%25'}"
          r="${r//$'\n'/'%0A'}"
          r="${r//$'\r'/'%0D'}"
          echo "::set-output name=release_body::$r"


      - name: ğŸ”– Create github release
        uses: ncipollo/release-action@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          allowUpdates: true
          replacesArtifacts: false
          name: "Factorio Bot v${{ env.PACKAGE_VERSION }}"
          tag: v${{ env.PACKAGE_VERSION }}
          body: "${{ steps.release.outputs.release_body }}"
          draft: false
          prerelease: true

  publish-autoupdater-json:
    name: Publish updater json files
    runs-on: ubuntu-latest
    needs: build-publish
    steps:
      - name: ğŸ”¥ Checkout code
        uses: actions/checkout@v6
      - name: ğŸ› ï¸ Install nodejs 16
        uses: actions/setup-node@v6
        with:
          node-version: 16

      # Download update jsons
      - name: ğŸ“¥ Download update json files from windows
        uses: actions/download-artifact@v7
        with:
          name: windows-latest
          path: updates-windows/
      - name: ğŸ“¥ Download update json files from linux
        uses: actions/download-artifact@v7
        with:
          name: ubuntu-latest
          path: updates-linux/
      - name: ğŸ“¥ Download update json files from macos
        uses: actions/download-artifact@v7
        with:
          name: macos-latest
          path: updates-macos/

      # Move update jsons to public/
      - name: ğŸ—ï¸ Move to public/
        run: |
          mkdir public/
          mkdir public/updates/
          mv updates-windows/* public/updates/
          mv updates-linux/* public/updates/
          mv updates-macos/* public/updates/
          cd app/scripts; node merge-auto-updater-json.js

      # Publish gh-pages
      - name: ğŸ“¤ Re-Deploy public/ to gh-pages (with keep_files)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./public
          force_orphan: false
          keep_files: true
