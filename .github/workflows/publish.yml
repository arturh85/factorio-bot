name: "publish"
on:
  push:
    tags:
      - 'v**'

jobs:
  build-publish:
    needs: create-github-release
    name: Build & Publish
    outputs:
      signature: ${{ steps.create_signature.outputs.signature }}
      release_body: ${{ needs.create-github-release.outputs.release_body }}
      package_version: ${{ needs.create-github-release.outputs.package_version }}
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.platform }}

    steps:
      # Prepare
      - name: ğŸ”¥ Checkout code
        uses: actions/checkout@v3
      - name: ğŸ› ï¸ Install nodejs 16
        uses: actions/setup-node@v3
        with:
          node-version: 16
      - name: ğŸ› ï¸ Install rust stable
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
      - uses: Swatinem/rust-cache@v1
      - uses: actions/cache@v3
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}
      - name: ğŸ› ï¸ Install tauri-cli
        run: |
          cargo install tauri-cli
      - name: ğŸ› ï¸ Install webkit2gtk for tauri-cli
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y webkit2gtk-4.0 libgtksourceview-3.0-dev
      - name: ğŸ› ï¸ Install mdbook with mermaid support
        if: matrix.platform == 'ubuntu-latest'
        run: |
          cargo install mdbook mdbook-mermaid

      # Javascript
      - name: ğŸ› ï¸ Install nodejs dependencies
        run: |
          cd app; yarn
      - name: ğŸ¦  Update version in package.json & tauri.conf.json
        id: create_version
        run: |
          cd app/scripts; node update-package-version.js
      - name: ğŸ§ª Lint javascript code
        run: |
          cd app; yarn lint
      - name: ğŸ§ª Test javascript code
        run: |
          cd app; yarn test:coverage
      - name: ğŸ—ï¸ Build javascript code
        run: |
          cd app; yarn build:web

      # Rust
      - name: ğŸ—ï¸ Build rust code
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        run: |
          cargo build --release --timings
          cd app && yarn tauri:build
      - name: ğŸ§ª Test rust code
        run: |
          cd app; yarn cargo:test

      # Publish tauri artifacts
      - name: ğŸ“¤ï¸ Upload artifacts to Github release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.create-github-release.outputs.id }}
          iconPath: "../public/logo.png"
          configPath: "tauri.conf.json"
          projectPath: "./app"
          tauriScript: "npm run dummy"

      # Output Signature
      - name: ğŸ—ï¸ Output Tauri Signature
        id: create_signature
        run: |
          cd app/scripts; node output-signature.js

      # Prepare gh-pages
      - name: ğŸ—ï¸ Build rust docs
        if: matrix.platform == 'ubuntu-latest'
        run: |
          mkdir public 
          cargo doc --all --no-deps
          mv target/doc public/doc
      - name: ğŸ—ï¸ Build mdbook "user guide"
        if: matrix.platform == 'ubuntu-latest'
        run: |
          mdbook build docs/userguide
          mv docs/userguide/book public/userguide
      - name: ğŸ—ï¸ Build mdbook "developer guide"
        if: matrix.platform == 'ubuntu-latest'
        run: |
          mdbook build docs/devguide
          mv docs/devguide/book public/devguide
      - name: ğŸ—ï¸ Prepare folder for lua api docs
        if: matrix.platform == 'ubuntu-latest'
        run: |
          mkdir public/lua/
      - name: ğŸ—ï¸ Build lua api docs
        if: matrix.platform == 'ubuntu-latest'
        continue-on-error: true
        uses: ./.github/actions/ldoc/
        with:
          config-path: docs/lua/config.ld
          source-path: docs/lua/src/
          output-path: ../public/lua/
      - name: ğŸ—ï¸ DEBUG
        if: matrix.platform == 'ubuntu-latest'
        run: |
          ls -alh . && ls -alh public/
          sudo chown -R $(id -u):$(id -g) public/
          sudo chown -R $(id -u):$(id -g) doc/
      - name: ğŸšš Move generated docs and stats to public/ folder
        if: matrix.platform == 'ubuntu-latest'
        run: |
          mv app/dist/stats.html public/stats.html
          mv target/cargo-timings/ public/cargo-timings/

      # Publish gh-pages
      - name: ğŸ“¤ Deploy public/ to gh-pages
        if: matrix.platform == 'ubuntu-latest'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./public
          force_orphan: true

  create-github-release:
    name: Create Github Release
    runs-on: ubuntu-latest
    outputs:
      id: ${{ steps.create_release.outputs.id }}
      release_body: ${{ steps.release.outputs.release_body }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@main
        with:
          fetch-depth: 0
      - name: ğŸ› ï¸ Install nodejs 16
        uses: actions/setup-node@v3
        with:
          node-version: 16
      - name: ğŸ¦  Update version in package.json & tauri.conf.json
        run: |
          cd app/scripts; node update-package-version.js
      - name: ğŸ”– Create github draft release
        uses: ncipollo/release-action@v1
        id: create_draft_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          allowUpdates: true
          replacesArtifacts: false
          name: "Factorio Bot v${{ env.PACKAGE_VERSION }}"
          tag: v${{ env.PACKAGE_VERSION }}
          body: "body filled later"
          draft: true
          prerelease: true
      - name: Generate changelog
        uses: orhun/git-cliff-action@v1
        id: git-cliff
        with:
          config: cliff.toml
          args: -vv --latest --strip header
        env:
          OUTPUT: CHANGES.md
      - name: Set the release body to changelog
        id: release
        shell: bash
        run: |
          r=$(cat ${{ steps.git-cliff.outputs.changelog }})
          r="$(printf "$r" | tail -n +3)"
          r="${r//'%'/'%25'}"
          r="${r//$'\n'/'%0A'}"
          r="${r//$'\r'/'%0D'}"
          echo "::set-output name=release_body::$r"


      - name: ğŸ”– Create github release
        uses: ncipollo/release-action@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          allowUpdates: true
          replacesArtifacts: false
          name: "Factorio Bot v${{ env.PACKAGE_VERSION }}"
          tag: v${{ env.PACKAGE_VERSION }}
          body: "${{ steps.release.outputs.release_body }}"
          draft: false
          prerelease: true

  publish-autoupdater-json:
    name: Publish updater signatures
    runs-on: ubuntu-latest
    needs: build-publish
    steps:
      - name: ğŸ”¥ Checkout code
        uses: actions/checkout@v3
      - name: ğŸ› ï¸ Install nodejs 16
        uses: actions/setup-node@v3
        with:
          node-version: 16
      - name: ğŸ—ï¸ Build auto-updater json files
        env:
          SIGNATURE_WINDOWS: ${{ needs.build-publish.windows-latest.outputs.signature }}
          SIGNATURE_LINUX: ${{ needs.build-publish.ubuntu-latest.outputs.signature }}
          SIGNATURE_MACOS: ${{ needs.build-publish.macos-latest.outputs.signature }}
          RELEASE_BODY: ${{ needs.build-publish.ubuntu-latest.outputs.release_body }}
          PACKAGE_VERSION: ${{ needs.build-publish.ubuntu-latest.outputs.package_version }}
        run: |
          mkdir public
          mkdir public/updates/
          cd app/scripts; node build-auto-updater-json.js
      # Publish gh-pages
      - name: ğŸ“¤ Deploy public/ to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./public
          force_orphan: false
          keep_files: true
