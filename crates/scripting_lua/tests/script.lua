BLUEPRINTS = {
    STARTER_STEAMENGINE_BOILER = "0eNqdkdEKwjAMRf8lz504nRv0V0Rkm0ECbVrWThxj/242RQXrgz6VhHtPLr0jNKZH3xFH0CNQ6ziA3o8Q6My1mXdx8AgaKKIFBVzbeQoRa5shn4kRJgXEJ7yCzqeDAuRIkfDOWYbhyL1tsBNBmqDAuyAmx/NFAWUiHOQppkl9QDYviK2NydBgGztqM+9MgvVAlSnU9rc8eYpR/BMnSdo9SY0jI5tvOYrVLuUvn35P/utpsUpLS5/6rX4FF+zCIq6qbZ5X1brcyP/fAHsdtKc=",
    STARTER_SCIENCE = "0eNqdlNtuwjAMht/F1w0iPUJfg8tpmtJglWg5VEnYhlDffUlBCKa2jF66tb/f9q/4DI08YmeF9lCfwWnWEW9Ia8U+xj9QlwmcoKa0T0Bwox3UbyFPtJrJmOFPHUINwqOCBDRTMWLOoWqk0C1RjB+ERkIhAvQeAzKwniIka+4q0v49AdReeIGXDobg9KGPqkEbkPPaCXTGhWKjr1ORvFwVw2TZqgg6Frm4dGGNJi0yS74PiBJiq3+00pe1ssVa2U1LaIfWh28j/PzKLwJ/BJL/C1LMQ4obxCkmJUGJ3FvBSWckzg09wSsXO1Y9bpEdvVEsZhLHBWqOpGP8c2yb1WLnlmtuXnJwO76s7UsOTkDoeqmFU0D68FxnLKN0gpA+I2QPhHAFhjNR352tJJaG1xOm8iyuZndxJPz4QusGWLqheZVvq7Ki67Io+/4XVduccQ==",
    FURNACE_LINE = "0eNqdm81vo0gQxf+ViLOd0NUf0D7ubTXSXuYwh9VoRJweL7sYEODsRlH+98WxZmKNaXiPk5UPfn5Vpqq7X+HX5LE6hbYr6yHZvSZPod93ZTuUTZ3sks/NqduHu7+Goe13Dw/fi/3QdGXz/t/9/b45PjyX4d+H7aemOv1h/37+cvg9DYeXfz59+5Jskr4u2u3QbA9d+XRm/5fsxG+Sl2Sn1NsmKR778bIhbM//15b1IdkN3SlsknLf1H2y+/M16ctDXVTna4eXNoyCyiEcR3JdHM8/DV1R923TDdvHUA3JyCzrpzC+zYhfvLgfmjpsv5+6utiHq2sFuHbftG3otm1VDNeXauDSsmvqmwvN29dNEuqhHMpwifz9h5dv9en4GLoxoFjMm6Rt+vLycb1nWN3b9xSn93bkP5Vd2F/++h7XL1ihsePr2wRIwyDN6DMwVhis/fg06j50w/i7G6CdD9jByiyjLIOxhsHmQMBuPmD/UTjHoqq2oRrfsCv327apwi0tm6epFA40YwJVeKE4iitABv1CzHiReEobXiU5xUXKRKULQeOFoqjWpfBS+akRAyPFovRC2GS5KJnnCV4viuqwQqwsVI8VpGKUWQgbLxlF9VnBa0ZRnVagolnojkIUDdUehSgaqj8KVDT5Qths0Sw0XE0UDdVxNVE0VMvVSNHI0l4MLxqhWq4mtmNUy9VI0chCi9R40QjVIjVeNEK1SI0UjSxsRDVZNLLQcg1eNEK1XIMXjVAt10BFs7C9NUTRUJ3RGPqMJRGJlibpCMlFTsG3h5cLZhKSoZBsBpKjED8D8SjkfDyIUWwKU/QMRcGUmdxagSkzybUapsxk1xqUInPZtTBlLrvwjStz2YXvXJnL7tWt21blMNl2fiyDiCnh6fK2vzYgM+VUpDTXRDwPBUQs0xG7KZ7QrtFNxJNcTfg7sVgNbfBYZDlwlrBiYtocbXJg2jLalMG4+TrvKBa+J7yYCCNLac8ECjVTtMeDcYXxYmJBa94ywdQZ3uTBwJbxYmJhO97iwNRlvCmDgfOV7lEsA57xYiKQPOUtEyjaXPEmDwYWxouJha15ywRTZ3iTBwNbxouJhe14iwNTl/GmDAbOV7pHsQx4xouJQHzKWyZQtF7xJg8GFsaLiYWtecsEU2d4kwcDW8aLiYXteIsDU5fxpgwGzle6R7EMeMaLMbHhYMqbMVC4KiXKJuPI+GFGco78UUyn+il0h64ZXyPsH03E3aA3P59HqNvT+WGJiXfivaoMOYKqlLeuHAZ2RG5kOTfNaYgmJ6NPqy52f+fEARVMhOcsvXxS2NVYfvl0iglTirMJI8Lklz5VFcc2fnKMJV5p4ugIxmc4BzMSHzVrB5U50haNSMuYMxgoLSe91og0D90VShZuC0mZ8xEWorBG8HSIQp1hQGmadJcj0gxzzgClWdKyjkhz2I3hl26MjDkDgCHmpJ8eCdEz+3RMmk5Jk35a2tV4HNhLg9KEdP4j0jSzPwWlGXKcEJHG75E8ps/R4BwDZ+Th4Ur2JI/ZFoGxe2JDgyGvBuSUmx2L2ihiTwJKpNxikKmZbQDINCt9zmguLbOQgyIdswKDzIxZOkHmWv8rmkzKAMNE2pRZtUAmtdyATFnpi8SSaamFBxTJH9cV+OSvpc+6KNnRj/Sj5Iye2KLknH4qHyV7euIKkompvyPJ/IgTJQs9lEXJmh9QomjDD1VRtOXniyh6xUwURWf8OA9F5/wIEkV7fhoHoolnDRRZi8TjBoosxkz4ASCKXvGAMope8Ygyirb86AlFO35chqJXTI5QdM5Pu1C05wdAU+ivm8u3L3dXX3LdJFUxosbf6fu734q+3N99Po7o8xdQN8lz6PrLxfm4Szc+c5lKnXVvb/8DoD9BzA==",
    MINER_LINE = "0eNqdl11v2yAUhv9KxLWdBPBH7MtN603Vq3ZSt2ma/MEyJAwIcFcr8n8vcapoWjztwJWFDQ+Hw3l5zQm1YmTacOlQfUI9s53h2nElUY0e1Wg6Vm9+Oadtvdv9bDqnDFdLd7vt1LB74ez3Ln24+/rhy2d83368e+0n3d4PzyhBVjY6dSo9Gt6f4a+oLhM0oZrgOUFNa5UYHUvP3TSXR1Q7M7IE8U5Ji+pvJ2T5UTbiPNRNmvmAuGODB8tmOLeYYJ0zvEsHLv34tDdcCOTRXPbMT4bn7wli0nHH2QW4NKYfchxaZnyH/6ASpJXll2Qs4eNtvizAP/00PTd+1PKVzMkNnVzpzjTSamVc2jLhbrH0Hbv/G5utYGlo0Pm/gi5W6Flw0AQSdB6MxRBsEbuBOWQDyyvdDo0Q6XUOrQS7ZZN3tl/BvEI7BKcgg6SgCsZSCBbvY8ssg5QZxsFhF6Cww0WXg7jRqitB6chiC/kAKWQcLr8DKCtFMLcEcSOVh/fr0sPh2sOgsxiHq6+CcEm0+m7jXqs3Eu98BGR94TLEIB8hNBwMchKSRWecgjKeR2cc5FUkXIoY5C+kDAeDHIZEiBLkASRclBhkAjRelQWkRmi8KitIjVASeayW68cqjRAjyFdo+F8oBhkLzaN3sALtYIQKQYZAw1VIVhzM34eWK1T9x60vQaLxJP/ugWw3nxojps2TUv79CzP2UkwHnJVZVRYl3hd5Mc9vau2sKw=="
}

ENTITIES = {
    ROCK_HUGE = "rock-huge",
    ROCK_BIG = "rock-big",
    WATER = "water",
    COAL = "coal",
    STONE = "stone",
    IRON_ORE = "iron-ore",
    COPPER_ORE = "copper-ore",
    BURNER_MINING_DRILL = "burner-mining-drill",
    STONE_FURNACE = "stone-furnace",
    OFFSHORE_PUMP = "offshore-pump",
    IRON_PLATE = "iron-plate",
    COPPER_PLATE = "copper-plate",
    STONE_BRICK = "stone-brick",
    IRON_CHEST = "iron-chest",
    STEAM_ENGINE = "steam-engine",
    BOILER = "boiler",
    SPLITTER = "splitter",
    SMALL_ELECTRIC_POLE = "small-electric-pole",
    PIPE = "pipe",
    PIPE_TO_GROUND = "pipe-to-ground",
    TRANSPORT_BELT = "transport-belt",
    UNDERGROUND_BELT = "underground-belt",
    LAB = "lab",
    AUTOMATION_SCIENCE_PACK = "automation-science-pack",
    WOOD = "wood",
    ASSEMBLING_MACHINE_1 = "assembling-machine-1",
    INSERTER = "inserter",
    IRON_GEAR_WHEEL = "iron-gear-wheel",
    ELECTRIC_MINING_DRILL = "electric-mining-drill",
}

TECHS = {
    AUTOMATION = "automation",
    LOGISTICS = "logistics",
    LOGISTICS_SCIENCE_PACK = "logistic-science-pack",
    STEEL_PROCESSING = "steel-processing",
    ROCKET_SILO = "rocket-silo",
}

local starter_mining_drills = {
    [ENTITIES.IRON_ORE] = {},
    [ENTITIES.COPPER_ORE] = {},
    [ENTITIES.STONE] = {},
    [ENTITIES.COAL] = {},
}

local starter_furnaces = {
    [ENTITIES.IRON_ORE] = {},
    [ENTITIES.COPPER_ORE] = {},
    [ENTITIES.STONE] = {},
}

function build_starter_base(bots)
    if #bots == 1 then
        local bot_id = bots[1]
        collect_rocks(bots, 3)

        -- place burner-mining-drill & stone-furnace @ iron-ore field
        build_starter_miner_furnace(bot_id, ENTITIES.IRON_ORE, 1)


        -- if not already get enough stone from rocks or stone ore for second burner-mining-drill
        -- craft second burner-mining-drill
        -- place stone burner-mining-drill
        -- loop get min 2x coal -> place in iron burner-mining-drill & stone-furnace -> get all iron-plate until enough for third burner-mining-drill
        -- loop get min 1x coal -> place in stone burner-mining-drill -> get all stone until enough for 2 more burner-mining-drill
        -- craft 2 more burner-mining-drill
        -- place coal burner-mining-drill loop with 2 elements & insert wood

        -- (build burner-mining-drill & stone-furnace @ copper-ore field)
    elseif #bots == 2 then
        print("not implemented for 2 bots")
        -- first bot =>
        -- place burner-mining-drill & stone-furnace @ iron-ore field
        build_starter_miner_furnace(all_bots[1], ENTITIES.IRON_ORE, 1)
        -- loop get min 2x coal from rocks or coal ore -> place in iron burner-mining-drill & stone-furnace -> get all iron-plate until enough for second burner-mining-drill
        -- second bot =>
        -- place burner-mining-drill @ stone field
        --buildStarterMiner(all_bots[1], "stone", 1)
        -- loop get min 1x coal from rocks or coal ore -> place in stone burner-mining-drill
    elseif #bots == 3 then
        print("not implemented for 3 bots")
        -- first bot =>
        -- place burner-mining-drill & stone-furnace @ iron-ore field
        -- loop get min 2x coal from rocks or coal ore -> place in iron burner-mining-drill & stone-furnace -> get all iron-plate until enough for second burner-mining-drill
        -- second bot =>
        -- give burner-mining-drill to third bot
        -- third bot =>
        -- wait for second bot to give BMD
        -- place coal burner-mining-drill loop with 2 elements & insert wood
    else
        print("not implemented for " .. str(all_bot_count) .. " bots")
    end

    -- buildStarterMinerFurnace(bots, "iron-ore", 2)
    --    build_starter_miner_loop("coal", 2)
    --    buildStarterMinerFurnace("iron-ore", 2)
    --    buildStarterMinerFurnace("copper-ore", 2)
    --    build_starter_miner_chest("stone", 2)
    --    build_starter_steam_engine()
    --    build_starter_science()
end


function build_starter_miner_furnace(bot, ore, count)
    local player = world.player(bot)
    local rect = world.find_free_resource_rect(ore, 2*count, 2, player.position)
    plan.group_start("Build Starter Miner/Furnace")
    ---- loop get min 2x coal from rocks or coal ore -> place in iron burner-mining-drill & stone-furnace -> get all iron-plate until enough for second burner-mining-drill
    --local recipe_bmd = world.recipe("burner-mining-drill")
    ----dump_recipe(recipe_bmd, 0)
    --local required_iron_plate = required_ingredients(recipe_bmd, "iron-plate", 1)
    --local required_stone_plate = required_ingredients(recipe_bmd, "stone", 1)
    --print("required_iron_plate: " .. tostring(required_iron_plate))
    --print("required_stone_plate: " .. tostring(required_stone_plate))
    --local player = world.player(bots[1])
    --dump(player.mainInventory, "inventory")

    local inventory = player.main_inventory
    --dump(player, "player")
    --dump(inventory, "inventory")

    -- FIXME: get/craft them instead of panicking
    assert(inventory[ENTITIES.BURNER_MINING_DRILL] >= count)
    assert(inventory[ENTITIES.STONE_FURNACE] >= count)

    local anchor = rect.left_top
    for idx=1,count do
        local mining_drill = plan.place(bot, { x=anchor.x + ((idx - 1) * 2), y=anchor.y}, ENTITIES.BURNER_MINING_DRILL)
        table.insert(starter_mining_drills[ore], mining_drill)

        local stone_furnace = plan.place(bot, { x=anchor.x + ((idx - 1) * 2), y=anchor.y-2}, ENTITIES.STONE_FURNACE)
        table.insert(starter_furnaces[ore], stone_furnace)
    end

    plan.group_end()
end


include("../../../scripts/lib.lua")
world.draw("world_start.png")
local botcnt = tostring(#all_bots)
print("start script for " .. botcnt .. " bots")

-- Milestone 1: Research Automation
-- Sub Target 1: Mine Iron & Copper
build_starter_base(all_bots)
-- Sub Target 2: Build Power Production near Water
-- Sub Target 3: Build Science Facilities

write_file("task_graph-" .. botcnt .. ".dot", plan.task_graph_graphviz())
write_file("task_graph-" .. botcnt .. ".md", "```mermaid\n" .. plan.task_graph_mermaid_gantt(all_bots, botcnt .. " bots") .. "\n```\n")
world.draw("world_end-" .. botcnt .. ".png")
print("end script")
--assert(false)
