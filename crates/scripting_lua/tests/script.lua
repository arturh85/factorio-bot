BLUEPRINTS = {
    STARTER_STEAMENGINE_BOILER = "0eNqdkdEKwjAMRf8lz504nRv0V0Rkm0ECbVrWThxj/242RQXrgz6VhHtPLr0jNKZH3xFH0CNQ6ziA3o8Q6My1mXdx8AgaKKIFBVzbeQoRa5shn4kRJgXEJ7yCzqeDAuRIkfDOWYbhyL1tsBNBmqDAuyAmx/NFAWUiHOQppkl9QDYviK2NydBgGztqM+9MgvVAlSnU9rc8eYpR/BMnSdo9SY0jI5tvOYrVLuUvn35P/utpsUpLS5/6rX4FF+zCIq6qbZ5X1brcyP/fAHsdtKc=",
    STARTER_SCIENCE = "0eNqdlNtuwjAMht/F1w0iPUJfg8tpmtJglWg5VEnYhlDffUlBCKa2jF66tb/f9q/4DI08YmeF9lCfwWnWEW9Ia8U+xj9QlwmcoKa0T0Bwox3UbyFPtJrJmOFPHUINwqOCBDRTMWLOoWqk0C1RjB+ERkIhAvQeAzKwniIka+4q0v49AdReeIGXDobg9KGPqkEbkPPaCXTGhWKjr1ORvFwVw2TZqgg6Frm4dGGNJi0yS74PiBJiq3+00pe1ssVa2U1LaIfWh28j/PzKLwJ/BJL/C1LMQ4obxCkmJUGJ3FvBSWckzg09wSsXO1Y9bpEdvVEsZhLHBWqOpGP8c2yb1WLnlmtuXnJwO76s7UsOTkDoeqmFU0D68FxnLKN0gpA+I2QPhHAFhjNR352tJJaG1xOm8iyuZndxJPz4QusGWLqheZVvq7Ki67Io+/4XVduccQ==",
    FURNACE_LINE = "0eNqdm81vo0gQxf+ViLOd0NUf0D7ubTXSXuYwh9VoRJweL7sYEODsRlH+98WxZmKNaXiPk5UPfn5Vpqq7X+HX5LE6hbYr6yHZvSZPod93ZTuUTZ3sks/NqduHu7+Goe13Dw/fi/3QdGXz/t/9/b45PjyX4d+H7aemOv1h/37+cvg9DYeXfz59+5Jskr4u2u3QbA9d+XRm/5fsxG+Sl2Sn1NsmKR778bIhbM//15b1IdkN3SlsknLf1H2y+/M16ctDXVTna4eXNoyCyiEcR3JdHM8/DV1R923TDdvHUA3JyCzrpzC+zYhfvLgfmjpsv5+6utiHq2sFuHbftG3otm1VDNeXauDSsmvqmwvN29dNEuqhHMpwifz9h5dv9en4GLoxoFjMm6Rt+vLycb1nWN3b9xSn93bkP5Vd2F/++h7XL1ihsePr2wRIwyDN6DMwVhis/fg06j50w/i7G6CdD9jByiyjLIOxhsHmQMBuPmD/UTjHoqq2oRrfsCv327apwi0tm6epFA40YwJVeKE4iitABv1CzHiReEobXiU5xUXKRKULQeOFoqjWpfBS+akRAyPFovRC2GS5KJnnCV4viuqwQqwsVI8VpGKUWQgbLxlF9VnBa0ZRnVagolnojkIUDdUehSgaqj8KVDT5Qths0Sw0XE0UDdVxNVE0VMvVSNHI0l4MLxqhWq4mtmNUy9VI0chCi9R40QjVIjVeNEK1SI0UjSxsRDVZNLLQcg1eNEK1XIMXjVAt10BFs7C9NUTRUJ3RGPqMJRGJlibpCMlFTsG3h5cLZhKSoZBsBpKjED8D8SjkfDyIUWwKU/QMRcGUmdxagSkzybUapsxk1xqUInPZtTBlLrvwjStz2YXvXJnL7tWt21blMNl2fiyDiCnh6fK2vzYgM+VUpDTXRDwPBUQs0xG7KZ7QrtFNxJNcTfg7sVgNbfBYZDlwlrBiYtocbXJg2jLalMG4+TrvKBa+J7yYCCNLac8ECjVTtMeDcYXxYmJBa94ywdQZ3uTBwJbxYmJhO97iwNRlvCmDgfOV7lEsA57xYiKQPOUtEyjaXPEmDwYWxouJha15ywRTZ3iTBwNbxouJhe14iwNTl/GmDAbOV7pHsQx4xouJQHzKWyZQtF7xJg8GFsaLiYWtecsEU2d4kwcDW8aLiYXteIsDU5fxpgwGzle6R7EMeMaLMbHhYMqbMVC4KiXKJuPI+GFGco78UUyn+il0h64ZXyPsH03E3aA3P59HqNvT+WGJiXfivaoMOYKqlLeuHAZ2RG5kOTfNaYgmJ6NPqy52f+fEARVMhOcsvXxS2NVYfvl0iglTirMJI8Lklz5VFcc2fnKMJV5p4ugIxmc4BzMSHzVrB5U50haNSMuYMxgoLSe91og0D90VShZuC0mZ8xEWorBG8HSIQp1hQGmadJcj0gxzzgClWdKyjkhz2I3hl26MjDkDgCHmpJ8eCdEz+3RMmk5Jk35a2tV4HNhLg9KEdP4j0jSzPwWlGXKcEJHG75E8ps/R4BwDZ+Th4Ur2JI/ZFoGxe2JDgyGvBuSUmx2L2ihiTwJKpNxikKmZbQDINCt9zmguLbOQgyIdswKDzIxZOkHmWv8rmkzKAMNE2pRZtUAmtdyATFnpi8SSaamFBxTJH9cV+OSvpc+6KNnRj/Sj5Iye2KLknH4qHyV7euIKkompvyPJ/IgTJQs9lEXJmh9QomjDD1VRtOXniyh6xUwURWf8OA9F5/wIEkV7fhoHoolnDRRZi8TjBoosxkz4ASCKXvGAMope8Ygyirb86AlFO35chqJXTI5QdM5Pu1C05wdAU+ivm8u3L3dXX3LdJFUxosbf6fu734q+3N99Po7o8xdQN8lz6PrLxfm4Szc+c5lKnXVvb/8DoD9BzA==",
    MINER_LINE = "0eNqdl11v2yAUhv9KxLWdBPBH7MtN603Vq3ZSt2ma/MEyJAwIcFcr8n8vcapoWjztwJWFDQ+Hw3l5zQm1YmTacOlQfUI9s53h2nElUY0e1Wg6Vm9+Oadtvdv9bDqnDFdLd7vt1LB74ez3Ln24+/rhy2d83368e+0n3d4PzyhBVjY6dSo9Gt6f4a+oLhM0oZrgOUFNa5UYHUvP3TSXR1Q7M7IE8U5Ji+pvJ2T5UTbiPNRNmvmAuGODB8tmOLeYYJ0zvEsHLv34tDdcCOTRXPbMT4bn7wli0nHH2QW4NKYfchxaZnyH/6ASpJXll2Qs4eNtvizAP/00PTd+1PKVzMkNnVzpzjTSamVc2jLhbrH0Hbv/G5utYGlo0Pm/gi5W6Flw0AQSdB6MxRBsEbuBOWQDyyvdDo0Q6XUOrQS7ZZN3tl/BvEI7BKcgg6SgCsZSCBbvY8ssg5QZxsFhF6Cww0WXg7jRqitB6chiC/kAKWQcLr8DKCtFMLcEcSOVh/fr0sPh2sOgsxiHq6+CcEm0+m7jXqs3Eu98BGR94TLEIB8hNBwMchKSRWecgjKeR2cc5FUkXIoY5C+kDAeDHIZEiBLkASRclBhkAjRelQWkRmi8KitIjVASeayW68cqjRAjyFdo+F8oBhkLzaN3sALtYIQKQYZAw1VIVhzM34eWK1T9x60vQaLxJP/ugWw3nxojps2TUv79CzP2UkwHnJVZVRYl3hd5Mc9vau2sKw=="
}

ENTITIES = {
    ROCK_HUGE = "rock-huge",
    ROCK_BIG = "rock-big",
    WATER = "water",
    COAL = "coal",
    STONE = "stone",
    IRON_ORE = "iron-ore",
    COPPER_ORE = "copper-ore",
    BURNER_MINING_DRILL = "burner-mining-drill",
    STONE_FURNACE = "stone-furnace",
    OFFSHORE_PUMP = "offshore-pump",
    IRON_PLATE = "iron-plate",
    COPPER_PLATE = "copper-plate",
    STONE_BRICK = "stone-brick",
    IRON_CHEST = "iron-chest",
    STEAM_ENGINE = "steam-engine",
    BOILER = "boiler",
    SPLITTER = "splitter",
    SMALL_ELECTRIC_POLE = "small-electric-pole",
    PIPE = "pipe",
    PIPE_TO_GROUND = "pipe-to-ground",
    TRANSPORT_BELT = "transport-belt",
    UNDERGROUND_BELT = "underground-belt",
    LAB = "lab",
    AUTOMATION_SCIENCE_PACK = "automation-science-pack",
    WOOD = "wood",
    ASSEMBLING_MACHINE_1 = "assembling-machine-1",
    INSERTER = "inserter",
    IRON_GEAR_WHEEL = "iron-gear-wheel",
    ELECTRIC_MINING_DRILL = "electric-mining-drill",
}

TECHS = {
    AUTOMATION = "automation",
    LOGISTICS = "logistics",
    LOGISTICS_SCIENCE_PACK = "logistic-science-pack",
    STEEL_PROCESSING = "steel-processing",
    ROCKET_SILO = "rocket-silo",
}

starter_mining_drills = {
    [ENTITIES.IRON_ORE] = {},
    [ENTITIES.COPPER_ORE] = {},
    [ENTITIES.STONE] = {},
    [ENTITIES.COAL] = {},
}

starter_furnaces = {
    [ENTITIES.IRON_ORE] = {},
    [ENTITIES.COPPER_ORE] = {},
    [ENTITIES.STONE] = {},
}

starter_coal_loop_rect = nil
starter_coal_loop_target = 8
starter_coal_loop_cnt = 0

function build_starter_coal_loop(bots, count)
    -- can only build pairs of coal miners for the loop
    assert(count % 2 == 0)

    if starter_coal_loop_rect == nil then
        local player = world.player(bots[1])
        starter_coal_loop_rect = world.find_free_resource_rect("coal", 2*starter_coal_loop_target, 4, player.position)
    end

    plan.group_start("Build Starter Coal Loop")
    local anchor = starter_coal_loop_rect.left_top
    for idx=1,count do
        local mining_drill = plan.place(bots[1], ENTITIES.BURNER_MINING_DRILL, { x=anchor.x + ((idx + starter_coal_loop_cnt - 1) * 2), y=anchor.y})
        table.insert(starter_mining_drills[ore], mining_drill)

        starter_coal_loop_cnt = starter_coal_loop_cnt + 1
    end
    plan.group_end()

end

function build_starter_miner_furnace(bots, ore, count)
    local player = world.player(bots[1])
    local rect = world.find_free_resource_rect(ore, 2*count, 2, player.position)
    plan.group_start("Build Starter Miner/Furnace")

    local anchor = rect.left_top
    for idx=1,count do
        local bot_id = bots[((idx - 1) * 2 % #bots) + 1];
        local mining_drill = starter_craft_place(bot_id, ENTITIES.BURNER_MINING_DRILL, { x=anchor.x + ((idx - 1) * 2), y=anchor.y}, 1) -- down
        table.insert(starter_mining_drills[ore], mining_drill)

        local stone_furnace = starter_craft_place(bot_id, ENTITIES.STONE_FURNACE, { x=anchor.x + ((idx - 1) * 2), y=anchor.y-2}, 4 ) -- up
        table.insert(starter_furnaces[ore], stone_furnace)
    end

    plan.group_end()
end

function starter_craft(bot, entity_name, count)

    local recipe = world.recipe(entity_name)
    dump(recipe.ingredients, "ingredients for " .. entity_name)
    player = world.player(bot)
    local inventory = player.main_inventory
    dump(inventory, "bot inventory")
end


function starter_craft_place(bot, entity_name, position, direction)
    starter_craft(bot, entity_name, 1)
    plan.place(bot, entity_name, position, direction)

    ---- loop get min 2x coal from rocks or coal ore -> place in iron burner-mining-drill & stone-furnace -> get all iron-plate until enough for second burner-mining-drill
    --local required_iron_plate = required_ingredients(recipe_bmd, "iron-plate", 1)
    --local required_stone_plate = required_ingredients(recipe_bmd, "stone", 1)
    --print("required_iron_plate: " .. tostring(required_iron_plate))
    --print("required_stone_plate: " .. tostring(required_stone_plate))
    --dump(player, "player")
    --dump(inventory, "inventory")
end

function craft_place_blueprint(bots, blueprint, position, direction)

end

function build_starter_mining(bots)
    mine_rocks(bots, 3)
    build_starter_miner_furnace(bots, ENTITIES.IRON_ORE, 1)
    --build_starter_coal_loop(bots, 2)
    --build_starter_miner_furnace(bots, ENTITIES.IRON_ORE, 2)
    --build_starter_miner_furnace(bots, ENTITIES.STONE, 2)
    --build_starter_miner_furnace(bots, ENTITIES.COPPER_ORE, 2)
end

function build_starter_power(bots)
    local offshore_pump_position, offshore_pump_direction = world.find_valid_offshore_pump()
    craft_place(bots, ENTITIES.OFFSHORE_PUMP, offshore_pump_position, offshore_pump_direction)
    local position = offshore_pump_direction
    -- FIXME finish logic
    if offshore_pump_direction == 1 then
        position.y = position.y - 1
    elseif offshore_pump_direction == 2 then
        position.y = position.y - 1
    elseif offshore_pump_direction == 3 then
        position.y = position.y - 1
    elseif offshore_pump_direction == 4 then
        position.y = position.y - 1
   end
    craft_place_blueprint(bots, BLUEPRINTS.STARTER_STEAMENGINE_BOILER, position)
end

function main()
    local bot_count = tostring(#all_bots)
    print("start script for " .. bot_count .. " bots")
    include("../../../scripts/lib.lua")
    world.draw("world_start.png")

    -- Milestone 1: Research Automation
    --   Sub Target 1: Starter Mine for Iron & Stone & Copper & Coal
    build_starter_mining(all_bots)
    --   Sub Target 2: Build Power Production near Water
    --build_starter_power(all_bots)
    --   Sub Target 3: Build Science Facilities
    --build_starter_science(all_bots)

    -- Milestone 2: Research Logistics


    file_write("task_graph-" .. bot_count .. ".dot", plan.task_graph_graphviz())
    file_write("task_graph-" .. bot_count .. ".md", "```mermaid\n" .. plan.task_graph_mermaid_gantt(all_bots, bot_count .. " bots") .. "\n```\n")
    world.draw("world_end-" .. bot_count .. ".png")
    print("end script")
end

main()
--assert(false)
